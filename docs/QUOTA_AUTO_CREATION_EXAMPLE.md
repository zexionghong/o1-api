# é…é¢ä½¿ç”¨è®°å½•è‡ªåŠ¨åˆ›å»ºç¤ºä¾‹

## ğŸ“‹ åœºæ™¯è®¾ç½®

**ç”¨æˆ·é…ç½®**ï¼š
- ç”¨æˆ·IDï¼š123
- é…é¢ç±»å‹ï¼šrequestsï¼ˆè¯·æ±‚æ¬¡æ•°ï¼‰
- é…é¢å‘¨æœŸï¼šmonthï¼ˆæŒ‰æœˆï¼‰
- é…é¢é™åˆ¶ï¼š1000æ¬¡/æœˆ
- é‡ç½®æ—¶é—´ï¼šæ¯æœˆ1æ—¥ 00:00

## ğŸ—“ï¸ æ—¶é—´çº¿ç¤ºä¾‹

### **2024å¹´6æœˆ1æ—¥ - é¦–æ¬¡ä½¿ç”¨**

#### 1. ç”¨æˆ·å‘èµ·ç¬¬ä¸€ä¸ªAPIè¯·æ±‚

```go
// é…é¢æ£€æŸ¥
allowed, err := quotaService.CheckQuota(ctx, 123, "requests", 1)
```

#### 2. ç³»ç»Ÿå†…éƒ¨å¤„ç†æµç¨‹

```go
// 1. è®¡ç®—å½“å‰å‘¨æœŸ
periodStart := time.Date(2024, 6, 1, 0, 0, 0, 0, time.UTC)  // 2024-06-01 00:00:00
periodEnd := time.Date(2024, 7, 1, 0, 0, 0, 0, time.UTC)    // 2024-07-01 00:00:00

// 2. æŸ¥è¯¢ç°æœ‰ä½¿ç”¨è®°å½•
usage, err := quotaUsageRepo.GetByQuotaAndPeriod(ctx, 123, 456, periodStart, periodEnd)
// ç»“æœï¼šæ²¡æœ‰æ‰¾åˆ°è®°å½• (err == entities.ErrUserNotFound)

// 3. è‡ªåŠ¨åˆ›å»ºæ–°è®°å½•
usage = &entities.QuotaUsage{
    UserID:      123,
    QuotaID:     456,
    PeriodStart: 2024-06-01 00:00:00,
    PeriodEnd:   2024-07-01 00:00:00,
    UsedValue:   0,                    // åˆå§‹ä½¿ç”¨é‡ä¸º0
    CreatedAt:   2024-06-01 10:30:00,
    UpdatedAt:   2024-06-01 10:30:00,
}

// 4. æ£€æŸ¥é…é¢æ˜¯å¦è¶³å¤Ÿ
// 0 + 1 <= 1000 âœ… å…è®¸

// 5. æ¶ˆè´¹é…é¢
quotaService.ConsumeQuota(ctx, 123, "requests", 1)

// 6. æ›´æ–°ä½¿ç”¨é‡
// UPDATE quota_usage SET used_value = used_value + 1 WHERE ...
// ç»“æœï¼šused_value = 1
```

#### 3. æ•°æ®åº“çŠ¶æ€

```sql
-- quota_usage è¡¨
| id | user_id | quota_id | period_start        | period_end          | used_value |
|----|---------|----------|---------------------|---------------------|------------|
| 1  | 123     | 456      | 2024-06-01 00:00:00 | 2024-07-01 00:00:00 | 1.0        |
```

### **2024å¹´6æœˆ15æ—¥ - æœˆä¸­ä½¿ç”¨**

#### 1. ç”¨æˆ·å‘èµ·æ›´å¤šè¯·æ±‚

```go
// é…é¢æ£€æŸ¥
allowed, err := quotaService.CheckQuota(ctx, 123, "requests", 5)
```

#### 2. ç³»ç»Ÿå†…éƒ¨å¤„ç†

```go
// 1. è®¡ç®—å½“å‰å‘¨æœŸï¼ˆåŒ6æœˆ1æ—¥ï¼‰
periodStart := 2024-06-01 00:00:00
periodEnd := 2024-07-01 00:00:00

// 2. æŸ¥è¯¢ç°æœ‰ä½¿ç”¨è®°å½•
usage, err := quotaUsageRepo.GetByQuotaAndPeriod(ctx, 123, 456, periodStart, periodEnd)
// ç»“æœï¼šæ‰¾åˆ°è®°å½•ï¼Œused_value = 150ï¼ˆå‡è®¾ä¹‹å‰å·²ä½¿ç”¨150æ¬¡ï¼‰

// 3. æ£€æŸ¥é…é¢
// 150 + 5 <= 1000 âœ… å…è®¸

// 4. æ¶ˆè´¹é…é¢
// UPDATE quota_usage SET used_value = used_value + 5 WHERE ...
// ç»“æœï¼šused_value = 155
```

### **2024å¹´7æœˆ1æ—¥ - æ–°æœˆä»½é¦–æ¬¡ä½¿ç”¨**

#### 1. ç”¨æˆ·å‘èµ·æ–°æœˆä»½çš„ç¬¬ä¸€ä¸ªè¯·æ±‚

```go
// é…é¢æ£€æŸ¥
allowed, err := quotaService.CheckQuota(ctx, 123, "requests", 1)
```

#### 2. ç³»ç»Ÿå†…éƒ¨å¤„ç†

```go
// 1. è®¡ç®—å½“å‰å‘¨æœŸï¼ˆæ–°çš„æœˆä»½ï¼‰
periodStart := time.Date(2024, 7, 1, 0, 0, 0, 0, time.UTC)  // 2024-07-01 00:00:00
periodEnd := time.Date(2024, 8, 1, 0, 0, 0, 0, time.UTC)    // 2024-08-01 00:00:00

// 2. æŸ¥è¯¢ç°æœ‰ä½¿ç”¨è®°å½•
usage, err := quotaUsageRepo.GetByQuotaAndPeriod(ctx, 123, 456, periodStart, periodEnd)
// ç»“æœï¼šæ²¡æœ‰æ‰¾åˆ°7æœˆçš„è®°å½• (err == entities.ErrUserNotFound)

// 3. è‡ªåŠ¨åˆ›å»º7æœˆçš„æ–°è®°å½•
usage = &entities.QuotaUsage{
    UserID:      123,
    QuotaID:     456,
    PeriodStart: 2024-07-01 00:00:00,
    PeriodEnd:   2024-08-01 00:00:00,
    UsedValue:   0,                    // 7æœˆé‡æ–°å¼€å§‹ï¼Œä½¿ç”¨é‡ä¸º0
    CreatedAt:   2024-07-01 09:15:00,
    UpdatedAt:   2024-07-01 09:15:00,
}

// 4. æ£€æŸ¥é…é¢
// 0 + 1 <= 1000 âœ… å…è®¸

// 5. æ¶ˆè´¹é…é¢
// åˆ›å»ºæ–°è®°å½•å¹¶è®¾ç½® used_value = 1
```

#### 3. æ•°æ®åº“çŠ¶æ€

```sql
-- quota_usage è¡¨ï¼ˆç°åœ¨æœ‰ä¸¤æ¡è®°å½•ï¼‰
| id | user_id | quota_id | period_start        | period_end          | used_value |
|----|---------|----------|---------------------|---------------------|------------|
| 1  | 123     | 456      | 2024-06-01 00:00:00 | 2024-07-01 00:00:00 | 1000.0     |
| 2  | 123     | 456      | 2024-07-01 00:00:00 | 2024-08-01 00:00:00 | 1.0        |
```

## ğŸ”„ **æŒ‰å‘¨é…é¢ç¤ºä¾‹**

### **é…ç½®**ï¼š
- é…é¢å‘¨æœŸï¼šweekï¼ˆæŒ‰å‘¨ï¼‰
- é…é¢é™åˆ¶ï¼š500æ¬¡/å‘¨
- å‘¨æœŸï¼šå‘¨ä¸€00:00å¼€å§‹

### **2024å¹´ç¬¬23å‘¨ï¼ˆ6æœˆ3æ—¥-6æœˆ9æ—¥ï¼‰**

```go
// 6æœˆ6æ—¥ï¼ˆå‘¨å››ï¼‰é¦–æ¬¡ä½¿ç”¨
periodStart := 2024-06-03 00:00:00  // æœ¬å‘¨å‘¨ä¸€
periodEnd := 2024-06-10 00:00:00    // ä¸‹å‘¨å‘¨ä¸€

// è‡ªåŠ¨åˆ›å»ºç¬¬23å‘¨çš„ä½¿ç”¨è®°å½•
usage = &entities.QuotaUsage{
    PeriodStart: 2024-06-03 00:00:00,
    PeriodEnd:   2024-06-10 00:00:00,
    UsedValue:   0,
}
```

### **2024å¹´ç¬¬24å‘¨ï¼ˆ6æœˆ10æ—¥-6æœˆ16æ—¥ï¼‰**

```go
// 6æœˆ10æ—¥ï¼ˆå‘¨ä¸€ï¼‰é¦–æ¬¡ä½¿ç”¨
periodStart := 2024-06-10 00:00:00  // æ–°å‘¨å‘¨ä¸€
periodEnd := 2024-06-17 00:00:00    // ä¸‹å‘¨å‘¨ä¸€

// è‡ªåŠ¨åˆ›å»ºç¬¬24å‘¨çš„ä½¿ç”¨è®°å½•
usage = &entities.QuotaUsage{
    PeriodStart: 2024-06-10 00:00:00,
    PeriodEnd:   2024-06-17 00:00:00,
    UsedValue:   0,
}
```

## ğŸ¯ **å…³é”®ç‰¹æ€§**

### âœ… **è‡ªåŠ¨åŒ–**
- **æ— éœ€æ‰‹åŠ¨åˆ›å»º**ï¼šç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹æ–°å‘¨æœŸå¹¶åˆ›å»ºè®°å½•
- **æ‡’åŠ è½½**ï¼šåªåœ¨éœ€è¦æ—¶åˆ›å»ºï¼Œä¸ä¼šé¢„å…ˆåˆ›å»ºæœªæ¥çš„è®°å½•
- **é›¶é…ç½®**ï¼šç”¨æˆ·æ— éœ€å…³å¿ƒå‘¨æœŸç®¡ç†

### ğŸ”’ **æ•°æ®ä¸€è‡´æ€§**
- **å”¯ä¸€çº¦æŸ**ï¼šæ•°æ®åº“çº¦æŸç¡®ä¿æ¯ä¸ªå‘¨æœŸåªæœ‰ä¸€æ¡è®°å½•
- **åŸå­æ“ä½œ**ï¼šåˆ›å»ºå’Œæ›´æ–°æ“ä½œæ˜¯åŸå­çš„
- **å¹¶å‘å®‰å…¨**ï¼šå¤šä¸ªè¯·æ±‚åŒæ—¶åˆ°è¾¾æ—¶ä¸ä¼šåˆ›å»ºé‡å¤è®°å½•

### ğŸ“Š **çµæ´»æ€§**
- **æ”¯æŒæ‰€æœ‰å‘¨æœŸç±»å‹**ï¼šåˆ†é’Ÿã€å°æ—¶ã€å¤©ã€å‘¨ã€æœˆ
- **ç²¾ç¡®çš„å‘¨æœŸè®¡ç®—**ï¼šåŸºäºé…é¢è®¾ç½®çš„é‡ç½®æ—¶é—´
- **å†å²è®°å½•ä¿ç•™**ï¼šæ¯ä¸ªå‘¨æœŸçš„ä½¿ç”¨è®°å½•éƒ½ä¼šä¿ç•™

### ğŸš€ **æ€§èƒ½ä¼˜åŒ–**
- **ç¼“å­˜é›†æˆ**ï¼šæ–°åˆ›å»ºçš„è®°å½•ä¼šç«‹å³ç¼“å­˜
- **æ‰¹é‡æ“ä½œ**ï¼šæ”¯æŒæ‰¹é‡æ›´æ–°ä½¿ç”¨é‡
- **ç´¢å¼•ä¼˜åŒ–**ï¼šæ•°æ®åº“ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½

## ğŸ“ˆ **ç›‘æ§å’Œè°ƒè¯•**

### ğŸ” **æŸ¥çœ‹è‡ªåŠ¨åˆ›å»ºçš„è®°å½•**

```sql
-- æŸ¥çœ‹ç”¨æˆ·123çš„æ‰€æœ‰é…é¢ä½¿ç”¨è®°å½•
SELECT 
    id,
    quota_id,
    period_start,
    period_end,
    used_value,
    created_at
FROM quota_usage 
WHERE user_id = 123 
ORDER BY period_start;
```

### ğŸ“Š **ç»Ÿè®¡ä¿¡æ¯**

```sql
-- ç»Ÿè®¡æ¯æœˆçš„é…é¢ä½¿ç”¨æƒ…å†µ
SELECT 
    DATE_FORMAT(period_start, '%Y-%m') as month,
    COUNT(*) as records_count,
    SUM(used_value) as total_usage
FROM quota_usage 
WHERE user_id = 123 
GROUP BY DATE_FORMAT(period_start, '%Y-%m')
ORDER BY month;
```

## ğŸ‰ **æ€»ç»“**

**æ˜¯çš„ï¼é…é¢ä½¿ç”¨è®°å½•ä¼šè‡ªåŠ¨åˆ›å»ºï¼**

- âœ… **æŒ‰æœˆé…é¢**ï¼šæ¯æœˆç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶è‡ªåŠ¨åˆ›å»ºå½“æœˆè®°å½•
- âœ… **æŒ‰å‘¨é…é¢**ï¼šæ¯å‘¨ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶è‡ªåŠ¨åˆ›å»ºå½“å‘¨è®°å½•  
- âœ… **æŒ‰æ—¥é…é¢**ï¼šæ¯å¤©ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶è‡ªåŠ¨åˆ›å»ºå½“æ—¥è®°å½•
- âœ… **æŒ‰å°æ—¶/åˆ†é’Ÿé…é¢**ï¼šæ¯ä¸ªæ—¶é—´æ®µç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶è‡ªåŠ¨åˆ›å»ºè®°å½•

ç”¨æˆ·å®Œå…¨ä¸éœ€è¦æ‰‹åŠ¨ç®¡ç†è¿™äº›è®°å½•ï¼Œç³»ç»Ÿä¼šæ™ºèƒ½åœ°å¤„ç†æ‰€æœ‰å‘¨æœŸç®¡ç†ï¼ğŸš€
