# é…é¢ç¼“å­˜æ—¥æœŸå¤„ç†æœºåˆ¶

## ğŸ“… é—®é¢˜æè¿°

æ‚¨æå‡ºçš„é—®é¢˜éå¸¸é‡è¦ï¼š**å¦‚æœ6.4å·å¼€å§‹é™é¢ï¼Œ6.5å·ä¹Ÿæœ‰ä¸ªé™é¢ï¼Œä»Šå¤©6.6å·ï¼Œé‚£ç¼“å­˜æ˜¯æ€ä¹ˆè®°å½•çš„ï¼Ÿ**

è¿™æ¶‰åŠåˆ°é…é¢ç¼“å­˜å¦‚ä½•å¤„ç†ä¸åŒæ—¥æœŸçš„é…é¢ä½¿ç”¨æƒ…å†µã€‚

## ğŸ” åŸå§‹é—®é¢˜åˆ†æ

### âŒ **ä¿®å¤å‰çš„é—®é¢˜**

åŸå§‹å®ç°ä¸­å­˜åœ¨ä¸€ä¸ªä¸¥é‡çš„ç¼“å­˜é”®å†²çªé—®é¢˜ï¼š

```go
// åŸå§‹çš„ç¼“å­˜é”®ç”Ÿæˆï¼ˆæœ‰é—®é¢˜ï¼‰
cacheKey := fmt.Sprintf("%d:%s:%s", userID, string(period), periodStart.Format("2006-01-02"))
finalKey := GetQuotaUsageCacheKey(userID, quotaType, period) // ä¸åŒ…å«æ—¥æœŸï¼
// ç»“æœï¼šquota_usage:123:requests:daily
```

**é—®é¢˜**ï¼š
- æ‰€æœ‰æ—¥æœŸçš„é…é¢ä½¿ç”¨éƒ½ä½¿ç”¨ç›¸åŒçš„ç¼“å­˜é”®
- 6æœˆ4æ—¥ã€6æœˆ5æ—¥ã€6æœˆ6æ—¥çš„æ•°æ®ä¼šç›¸äº’è¦†ç›–
- æ— æ³•åŒæ—¶ç¼“å­˜å¤šå¤©çš„é…é¢ä½¿ç”¨æƒ…å†µ

## âœ… **ä¿®å¤åçš„è§£å†³æ–¹æ¡ˆ**

### ğŸ”§ **æ–°çš„ç¼“å­˜é”®è®¾è®¡**

ä¿®å¤åçš„ç¼“å­˜é”®åŒ…å«å®Œæ•´çš„æ—¥æœŸä¿¡æ¯ï¼š

```go
// æ–°çš„ç¼“å­˜é”®ç”Ÿæˆï¼ˆå·²ä¿®å¤ï¼‰
periodKey := s.generatePeriodKey(period, periodStart)
cacheKey := fmt.Sprintf("quota_usage:user:%d:quota:%d:period:%s", userID, quotaID, periodKey)
```

### ğŸ“Š **å…·ä½“ç¤ºä¾‹**

å‡è®¾ç”¨æˆ·IDä¸º123ï¼Œé…é¢IDä¸º456ï¼Œé…é¢ç±»å‹ä¸º"requests"ï¼Œå‘¨æœŸä¸º"daily"ï¼š

#### **6æœˆ4æ—¥ï¼ˆ2024-06-04ï¼‰**
- **periodStart**: `2024-06-04 00:00:00`
- **periodKey**: `day:2024-06-04`
- **ç¼“å­˜é”®**: `quota_usage:user:123:quota:456:period:day:2024-06-04`
- **å­˜å‚¨å†…å®¹**: 6æœˆ4æ—¥çš„é…é¢ä½¿ç”¨æƒ…å†µ

#### **6æœˆ5æ—¥ï¼ˆ2024-06-05ï¼‰**
- **periodStart**: `2024-06-05 00:00:00`
- **periodKey**: `day:2024-06-05`
- **ç¼“å­˜é”®**: `quota_usage:user:123:quota:456:period:day:2024-06-05`
- **å­˜å‚¨å†…å®¹**: 6æœˆ5æ—¥çš„é…é¢ä½¿ç”¨æƒ…å†µ

#### **6æœˆ6æ—¥ï¼ˆ2024-06-06ï¼‰**
- **periodStart**: `2024-06-06 00:00:00`
- **periodKey**: `day:2024-06-06`
- **ç¼“å­˜é”®**: `quota_usage:user:123:quota:456:period:day:2024-06-06`
- **å­˜å‚¨å†…å®¹**: 6æœˆ6æ—¥çš„é…é¢ä½¿ç”¨æƒ…å†µ

## ğŸ—ï¸ **å‘¨æœŸé”®ç”Ÿæˆè§„åˆ™**

### `generatePeriodKey` æ–¹æ³•å®ç°

```go
func (s *quotaServiceImpl) generatePeriodKey(period entities.QuotaPeriod, periodStart time.Time) string {
    switch period {
    case entities.QuotaPeriodMinute:
        // æ ¼å¼ï¼šminute:2024-06-06:14:30
        return fmt.Sprintf("minute:%s", periodStart.Format("2006-01-02:15:04"))
    case entities.QuotaPeriodHour:
        // æ ¼å¼ï¼šhour:2024-06-06:14
        return fmt.Sprintf("hour:%s", periodStart.Format("2006-01-02:15"))
    case entities.QuotaPeriodDay:
        // æ ¼å¼ï¼šday:2024-06-06
        return fmt.Sprintf("day:%s", periodStart.Format("2006-01-02"))
    case entities.QuotaPeriodMonth:
        // æ ¼å¼ï¼šmonth:2024-06
        return fmt.Sprintf("month:%s", periodStart.Format("2006-01"))
    default:
        // é»˜è®¤ä¸ºå°æ—¶
        return fmt.Sprintf("hour:%s", periodStart.Format("2006-01-02:15"))
    }
}
```

### ğŸ“‹ **ä¸åŒå‘¨æœŸçš„ç¼“å­˜é”®ç¤ºä¾‹**

#### **åˆ†é’Ÿçº§é…é¢**
- **ç¼“å­˜é”®**: `quota_usage:user:123:quota:456:period:minute:2024-06-06:14:30`
- **å«ä¹‰**: 2024å¹´6æœˆ6æ—¥14:30è¿™ä¸€åˆ†é’Ÿçš„é…é¢ä½¿ç”¨

#### **å°æ—¶çº§é…é¢**
- **ç¼“å­˜é”®**: `quota_usage:user:123:quota:456:period:hour:2024-06-06:14`
- **å«ä¹‰**: 2024å¹´6æœˆ6æ—¥14ç‚¹è¿™ä¸€å°æ—¶çš„é…é¢ä½¿ç”¨

#### **æ—¥çº§é…é¢**
- **ç¼“å­˜é”®**: `quota_usage:user:123:quota:456:period:day:2024-06-06`
- **å«ä¹‰**: 2024å¹´6æœˆ6æ—¥è¿™ä¸€å¤©çš„é…é¢ä½¿ç”¨

#### **æœˆçº§é…é¢**
- **ç¼“å­˜é”®**: `quota_usage:user:123:quota:456:period:month:2024-06`
- **å«ä¹‰**: 2024å¹´6æœˆè¿™ä¸€ä¸ªæœˆçš„é…é¢ä½¿ç”¨

## ğŸ”„ **ç¼“å­˜ç”Ÿå‘½å‘¨æœŸç®¡ç†**

### â° **TTLç­–ç•¥**

ä¸åŒå‘¨æœŸçš„é…é¢ä½¿ç”¨ç¼“å­˜é‡‡ç”¨ä¸åŒçš„TTLï¼š

```go
ttl := time.Duration(2) * time.Minute // é…é¢ä½¿ç”¨æƒ…å†µç¼“å­˜2åˆ†é’Ÿ
```

**ä¸ºä»€ä¹ˆæ˜¯2åˆ†é’Ÿï¼Ÿ**
- **å®æ—¶æ€§è¦æ±‚**ï¼šé…é¢ä½¿ç”¨éœ€è¦ç›¸å¯¹å®æ—¶çš„æ•°æ®
- **æ€§èƒ½å¹³è¡¡**ï¼šé¿å…è¿‡äºé¢‘ç¹çš„æ•°æ®åº“æŸ¥è¯¢
- **æ•°æ®ä¸€è‡´æ€§**ï¼šçŸ­TTLç¡®ä¿æ•°æ®ä¸ä¼šè¿‡æ—¶å¤ªä¹…

### ğŸ—‘ï¸ **ç¼“å­˜å¤±æ•ˆç­–ç•¥**

#### **ä¸»åŠ¨å¤±æ•ˆ**
å½“ç”¨æˆ·æ¶ˆè´¹é…é¢åï¼Œä¼šä¸»åŠ¨å¤±æ•ˆç›¸å…³ç¼“å­˜ï¼š

```go
// å¤±æ•ˆç”¨æˆ·é…é¢ä½¿ç”¨æƒ…å†µç¼“å­˜ï¼ˆä½¿ç”¨æ¨¡å¼åŒ¹é…ï¼‰
pattern := fmt.Sprintf("quota_usage:user:%d:*", userID)
invalidationService.BatchInvalidate(ctx, []InvalidationOperation{
    NewPatternInvalidation(pattern),
})
```

#### **æ¨¡å¼åŒ¹é…å¤±æ•ˆ**
- **æ¨¡å¼**: `quota_usage:user:123:*`
- **æ•ˆæœ**: åˆ é™¤ç”¨æˆ·123çš„æ‰€æœ‰é…é¢ä½¿ç”¨ç¼“å­˜
- **åŒ…å«**: æ‰€æœ‰æ—¥æœŸã€æ‰€æœ‰é…é¢ã€æ‰€æœ‰å‘¨æœŸçš„ç¼“å­˜

## ğŸ“Š **å®é™…è¿è¡Œç¤ºä¾‹**

### ğŸ¯ **åœºæ™¯ï¼šç”¨æˆ·åœ¨ä¸åŒæ—¥æœŸçš„é…é¢ä½¿ç”¨**

å‡è®¾ç”¨æˆ·123æœ‰ä¸€ä¸ªæ—¥é…é¢é™åˆ¶100æ¬¡è¯·æ±‚ï¼š

#### **6æœˆ4æ—¥**
1. **é¦–æ¬¡æŸ¥è¯¢**ï¼šç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“ï¼Œå·²ä½¿ç”¨50æ¬¡
2. **ç¼“å­˜å­˜å‚¨**ï¼š`quota_usage:user:123:quota:456:period:day:2024-06-04` â†’ ä½¿ç”¨50æ¬¡
3. **åç»­æŸ¥è¯¢**ï¼šç›´æ¥ä»ç¼“å­˜è·å–ï¼Œä½¿ç”¨50æ¬¡

#### **6æœˆ5æ—¥**
1. **é¦–æ¬¡æŸ¥è¯¢**ï¼šç¼“å­˜æœªå‘½ä¸­ï¼ˆæ–°çš„æ—¥æœŸï¼‰ï¼ŒæŸ¥è¯¢æ•°æ®åº“ï¼Œå·²ä½¿ç”¨30æ¬¡
2. **ç¼“å­˜å­˜å‚¨**ï¼š`quota_usage:user:123:quota:456:period:day:2024-06-05` â†’ ä½¿ç”¨30æ¬¡
3. **åç»­æŸ¥è¯¢**ï¼šç›´æ¥ä»ç¼“å­˜è·å–ï¼Œä½¿ç”¨30æ¬¡

#### **6æœˆ6æ—¥ï¼ˆä»Šå¤©ï¼‰**
1. **é¦–æ¬¡æŸ¥è¯¢**ï¼šç¼“å­˜æœªå‘½ä¸­ï¼ˆæ–°çš„æ—¥æœŸï¼‰ï¼ŒæŸ¥è¯¢æ•°æ®åº“ï¼Œå·²ä½¿ç”¨0æ¬¡
2. **ç¼“å­˜å­˜å‚¨**ï¼š`quota_usage:user:123:quota:456:period:day:2024-06-06` â†’ ä½¿ç”¨0æ¬¡
3. **ç”¨æˆ·å‘èµ·è¯·æ±‚**ï¼šæ¶ˆè´¹1æ¬¡é…é¢
4. **ç¼“å­˜å¤±æ•ˆ**ï¼šåˆ é™¤ `quota_usage:user:123:quota:456:period:day:2024-06-06`
5. **ä¸‹æ¬¡æŸ¥è¯¢**ï¼šç¼“å­˜æœªå‘½ä¸­ï¼ŒæŸ¥è¯¢æ•°æ®åº“ï¼Œå·²ä½¿ç”¨1æ¬¡

### ğŸ” **Redisä¸­çš„å®é™…å­˜å‚¨**

åœ¨Redisä¸­ï¼ŒåŒæ—¶å­˜åœ¨å¤šä¸ªæ—¥æœŸçš„ç¼“å­˜ï¼š

```
quota_usage:user:123:quota:456:period:day:2024-06-04 â†’ {used: 50, limit: 100, ...}
quota_usage:user:123:quota:456:period:day:2024-06-05 â†’ {used: 30, limit: 100, ...}
quota_usage:user:123:quota:456:period:day:2024-06-06 â†’ {used: 1, limit: 100, ...}
```

## ğŸ¯ **ä¼˜åŠ¿å’Œç‰¹ç‚¹**

### âœ… **è§£å†³çš„é—®é¢˜**

1. **æ•°æ®éš”ç¦»**ï¼šä¸åŒæ—¥æœŸçš„é…é¢ä½¿ç”¨æ•°æ®å®Œå…¨éš”ç¦»
2. **å†å²ä¿ç•™**ï¼šå¯ä»¥åŒæ—¶ç¼“å­˜å¤šå¤©çš„å†å²æ•°æ®
3. **ç²¾ç¡®æŸ¥è¯¢**ï¼šå¯ä»¥ç²¾ç¡®æŸ¥è¯¢ä»»æ„æ—¥æœŸçš„é…é¢ä½¿ç”¨æƒ…å†µ
4. **æ— å†²çª**ï¼šä¸åŒæ—¥æœŸçš„ç¼“å­˜é”®å®Œå…¨ä¸åŒï¼Œä¸ä¼šç›¸äº’è¦†ç›–

### ğŸš€ **æ€§èƒ½ä¼˜åŠ¿**

1. **å‡å°‘æ•°æ®åº“æŸ¥è¯¢**ï¼šç›¸åŒæ—¥æœŸçš„é‡å¤æŸ¥è¯¢ç›´æ¥ä»ç¼“å­˜è·å–
2. **æ”¯æŒå†å²æŸ¥è¯¢**ï¼šå†å²æ—¥æœŸçš„æ•°æ®ä¹Ÿå¯ä»¥ä»ç¼“å­˜è·å–
3. **æ™ºèƒ½å¤±æ•ˆ**ï¼šåªæœ‰å½“å‰æ—¥æœŸçš„ç¼“å­˜ä¼šåœ¨é…é¢æ¶ˆè´¹åå¤±æ•ˆ

### ğŸ”’ **æ•°æ®ä¸€è‡´æ€§**

1. **çŸ­æœŸTTL**ï¼š2åˆ†é’Ÿçš„TTLç¡®ä¿æ•°æ®ä¸ä¼šè¿‡æ—¶å¤ªä¹…
2. **ä¸»åŠ¨å¤±æ•ˆ**ï¼šé…é¢æ¶ˆè´¹åç«‹å³å¤±æ•ˆå½“å‰ç¼“å­˜
3. **æ¨¡å¼åŒ¹é…**ï¼šå¯ä»¥æ‰¹é‡æ¸…ç†ç”¨æˆ·çš„æ‰€æœ‰é…é¢ç¼“å­˜

## ğŸ“ˆ **ç›‘æ§å’Œè°ƒè¯•**

### ğŸ” **ç¼“å­˜é”®æŸ¥çœ‹**

å¯ä»¥é€šè¿‡Redis CLIæŸ¥çœ‹å®é™…çš„ç¼“å­˜é”®ï¼š

```bash
# æŸ¥çœ‹ç”¨æˆ·123çš„æ‰€æœ‰é…é¢ä½¿ç”¨ç¼“å­˜
redis-cli KEYS "quota_usage:user:123:*"

# æŸ¥çœ‹ç‰¹å®šæ—¥æœŸçš„ç¼“å­˜
redis-cli KEYS "quota_usage:user:123:*:day:2024-06-06"
```

### ğŸ“Š **æ—¥å¿—è®°å½•**

ç³»ç»Ÿä¼šè®°å½•è¯¦ç»†çš„ç¼“å­˜æ“ä½œæ—¥å¿—ï¼š

```
DEBUG: Quota usage cached successfully user_id=123 quota_id=456 cache_key=quota_usage:user:123:quota:456:period:day:2024-06-06 period=daily
```

è¿™æ ·æ‚¨å°±å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°æ¯ä¸ªæ—¥æœŸçš„é…é¢ä½¿ç”¨æƒ…å†µæ˜¯å¦‚ä½•è¢«ç‹¬ç«‹ç¼“å­˜å’Œç®¡ç†çš„ï¼
